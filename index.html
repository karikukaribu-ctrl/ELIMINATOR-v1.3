<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Eliminator</title>
  <style>
    :root{
      --bg:#0f1115;
      --fg:#e9edf5;
      --muted:#a8b0bd;
      --line:#2a2f3a;
      --panel:#141823;
      --panel2:#101421;
      --chip:#0b0d12;
      --btn:#0b0d12;
      --btn2:#121725;
      --shadow: 0 16px 40px rgba(0,0,0,0.45);

      --accent1:#f2f2f2;
      --accent2:#aeb7c7;

      --danger:#ffb3b3;
      --ok:#b7f7d6;

      --radius:16px;
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--fg);
      overflow-x:hidden;
    }

    .app{
      min-height:100%;
      max-width: 980px;
      margin: 0 auto;
      padding: 12px;
      display:grid;
      grid-template-rows: auto auto 1fr;
      gap:10px;
    }

    header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
    }
    .brand{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
    }
    .brand h1{
      margin:0;
      font-size:18px;
      font-weight:900;
      letter-spacing:0.2px;
      line-height:1.1;
    }
    .brand .sub{
      font-size:12px;
      color:var(--muted);
      letter-spacing:0.06em;
    }

    .topRight{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .btn{
      border:1px solid var(--line);
      background:var(--btn);
      color:var(--fg);
      border-radius:14px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:800;
      letter-spacing:0.02em;
    }
    .btn:hover{ border-color:#3b4456; }
    .btn:active{ transform: translateY(1px); }
    .btn:disabled{ opacity:0.5; cursor:not-allowed; }

    .btn.small{ padding:8px 10px; border-radius:12px; font-weight:850; font-size:12px; }
    .btn.danger{ border-color: rgba(255,179,179,0.35); }
    .btn.ok{ border-color: rgba(183,247,214,0.25); }

    .miniMap{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:8px;
    }

    .tab{
      border:1px solid var(--line);
      background:var(--btn);
      color:var(--fg);
      border-radius:14px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:900;
      letter-spacing:0.06em;
      text-transform:uppercase;
      font-size:12px;
    }
    .tab.active{
      border-color: rgba(242,242,242,0.28);
      background: linear-gradient(90deg, rgba(242,242,242,0.10), rgba(174,183,199,0.10)), var(--btn);
    }

    .card{
      background:linear-gradient(180deg,var(--panel),var(--panel2));
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding: 12px;
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    @media (min-width: 860px){
      .grid2{ grid-template-columns: 1fr 1fr; }
    }

    textarea{
      width:100%;
      min-height: 110px;
      resize: vertical;
      border-radius: 14px;
      border:1px solid var(--line);
      background: var(--chip);
      color: var(--fg);
      padding: 12px;
      font-size: 14px;
      line-height: 1.35;
      outline: none;
    }
    textarea:focus{ border-color: rgba(242,242,242,0.22); }

    .row{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }

    .quiet{
      color: var(--muted);
      font-size: 12px;
    }

    .list{
      display:grid;
      gap:8px;
      margin-top: 10px;
    }

    .task{
      border:1px solid var(--line);
      border-radius: 14px;
      background: var(--chip);
      padding: 10px;
      display:grid;
      gap:8px;
    }

    .taskTop{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
    }
    .taskText{
      font-weight: 900;
      word-break: break-word;
      line-height: 1.2;
    }
    .pillRow{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      align-items:center;
    }
    .pill{
      border:1px solid var(--line);
      background: rgba(0,0,0,0.12);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1;
      white-space: nowrap;
    }

    .controls{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    select, input[type="number"], input[type="text"]{
      border:1px solid var(--line);
      background: #0b0d12;
      color: var(--fg);
      border-radius: 12px;
      padding: 8px 10px;
      font-weight: 800;
      font-size: 12px;
      outline:none;
    }
    select:focus, input:focus{ border-color: rgba(242,242,242,0.22); }

    .editRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:8px;
    }
    @media (min-width: 520px){
      .editRow{ grid-template-columns: 1fr 1fr 1fr 1fr; }
    }

    .dragHint{
      color: var(--muted);
      font-size: 11px;
    }

    /* Focus mode */
    body.focus .app{
      max-width: 740px;
    }
    body.focus header,
    body.focus .miniMap,
    body.focus .triageView,
    body.focus .captureView{
      display:none !important;
    }
    .focusView{ display:none; }
    body.focus .focusView{ display:block; }

    .focusWrap{
      min-height: calc(100vh - 24px);
      display:grid;
      gap:12px;
      align-content:center;
    }

    .focusCard{
      border:1px solid rgba(242,242,242,0.12);
      background:
        radial-gradient(900px 260px at 30% 20%, rgba(242,242,242,0.14), transparent 60%),
        linear-gradient(180deg, var(--panel), var(--panel2));
      border-radius: 20px;
      padding: 16px;
      box-shadow: var(--shadow);
      display:grid;
      gap:12px;
    }

    .focusTask{
      font-size: 22px;
      font-weight: 950;
      line-height: 1.15;
      word-break: break-word;
    }

    .focusStats{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .stat{
      border:1px solid var(--line);
      background: var(--chip);
      border-radius: 16px;
      padding: 12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .stat span{ color:var(--muted); font-size:12px; font-weight:800; }
    .stat b{ font-size:16px; font-weight:950; }

    .ring{
      width: 140px;
      height: 140px;
      border-radius: 999px;
      background:
        conic-gradient(from -90deg, var(--accent1) 0deg, var(--accent2) var(--p), rgba(255,255,255,0.06) var(--p), rgba(255,255,255,0.06) 360deg);
      position:relative;
      box-shadow: var(--shadow);
      margin-left:auto;
      margin-right:auto;
    }
    .ring::before{
      content:"";
      position:absolute;
      inset: 14px;
      border-radius:999px;
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      border:1px solid rgba(255,255,255,0.08);
    }
    .ringCenter{
      position:absolute;
      inset:0;
      display:grid;
      place-items:center;
      text-align:center;
      pointer-events:none;
    }
    .ringCenter .pct{ font-size: 26px; font-weight: 950; }
    .ringCenter .lbl{ font-size: 11px; color: var(--muted); letter-spacing:0.08em; }

    .focusBtns{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    @media (min-width: 520px){
      .focusBtns{ grid-template-columns: 1fr 1fr; }
    }

    .bigBtn{
      border:1px solid rgba(242,242,242,0.16);
      background:
        radial-gradient(800px 240px at 30% 20%, rgba(242,242,242,0.12), transparent 60%),
        linear-gradient(180deg, #0b0d12, #0a0c10);
      color:var(--fg);
      border-radius: 18px;
      padding: 16px 14px;
      cursor:pointer;
      font-weight: 950;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      box-shadow: var(--shadow);
      min-height: 58px;
    }
    .bigBtn:hover{ border-color: rgba(242,242,242,0.28); }
    .bigBtn:active{ transform: translateY(1px); }
    .bigBtn:disabled{ opacity:0.5; cursor:not-allowed; box-shadow:none; }

    .bigBtn.primary{
      background:
        radial-gradient(900px 260px at 30% 20%, rgba(242,242,242,0.22), transparent 60%),
        linear-gradient(90deg, rgba(242,242,242,0.10), rgba(174,183,199,0.10)),
        linear-gradient(180deg, #0b0d12, #0a0c10);
    }

    /* Panel */
    .panel{
      display:none;
    }
    body.panelOpen .panel{
      display:block;
    }
    .panel .row{
      justify-content:flex-start;
    }
    .panelGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    @media (min-width: 860px){
      .panelGrid{ grid-template-columns: 1fr 1fr; }
    }

    .toast{
      position:fixed;
      left:50%;
      bottom: 18px;
      transform:translateX(-50%);
      background:#0b0d12;
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      color:var(--fg);
      font-size:13px;
      opacity:0;
      pointer-events:none;
      transition:opacity 140ms ease, transform 140ms ease;
      max-width: min(900px, calc(100vw - 24px));
      box-shadow: var(--shadow);
      white-space:pre-wrap;
      z-index: 50;
    }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(-6px); }

    .done{
      text-decoration: line-through;
      opacity: 0.55;
    }

    /* Drag styles */
    .task[draggable="true"]{ cursor:grab; }
    .task.dragging{ opacity: 0.6; }
    .dropZone{
      outline: 2px dashed rgba(242,242,242,0.18);
      outline-offset: 6px;
      border-radius: 14px;
    }
  </style>
</head>

<body class="panelOpen">
  <div class="app">
    <header>
      <div class="brand">
        <h1>Eliminator</h1>
        <div class="sub">des gommes d'ethorion</div>
      </div>

      <div class="topRight">
        <button class="btn small" id="btnPresetPrev" title="Preset précédent">◀</button>
        <button class="btn small" id="btnPreset" title="Preset (Alt+←/→)">Base</button>
        <button class="btn small" id="btnPresetNext" title="Preset suivant">▶</button>

        <button class="btn small" id="btnPanel">Panneau</button>
        <button class="btn small ok" id="btnUndo" title="Ctrl/⌘+Z">Undo</button>
        <button class="btn small ok" id="btnRedo" title="Ctrl/⌘+Shift+Z">Redo</button>
      </div>
    </header>

    <div class="miniMap" role="tablist" aria-label="Navigation">
      <button class="tab active" id="tabCapture" role="tab" aria-selected="true">Inbox</button>
      <button class="tab" id="tabTriage" role="tab" aria-selected="false">Tri</button>
      <button class="tab" id="tabFocus" role="tab" aria-selected="false">Focus</button>
    </div>

    <!-- Panneau -->
    <section class="card panel" aria-label="Panneau">
      <div class="panelGrid">
        <div class="card" style="padding:12px;">
          <div class="row">
            <div class="quiet">Torion =</div>
            <select id="selTorionMinutes" aria-label="Durée torion">
              <option value="5">5 minutes</option>
              <option value="10">10 minutes</option>
            </select>

            <div class="quiet">Énergie</div>
            <select id="selEnergyFilter" aria-label="Filtre énergie">
              <option value="tous">Tous</option>
              <option value="faible">Faible</option>
              <option value="moyen">Moyen</option>
              <option value="haut">Haut</option>
            </select>

            <div class="quiet">Tunnel</div>
            <select id="selTunnel" aria-label="Mode Tunnel">
              <option value="off">Off</option>
              <option value="on">On</option>
            </select>
          </div>
        </div>

        <div class="card" style="padding:12px;">
          <div class="row">
            <button class="btn small" id="btnExport">Export</button>
            <button class="btn small" id="btnImport">Import</button>
            <button class="btn small danger" id="btnResetAll">Reset</button>
          </div>
        </div>

        <div class="card" style="padding:12px;">
          <div class="row">
            <button class="btn small" id="btnPresetAdd">+ Preset</button>
            <button class="btn small" id="btnPresetEdit">Éditer</button>
            <button class="btn small danger" id="btnPresetDel">Supprimer</button>
          </div>
          <div class="quiet" style="margin-top:8px;">
            Switch: Alt + ← / →
          </div>
        </div>

        <div class="card" style="padding:12px;">
          <div class="row">
            <button class="btn small" id="btnPanic">Panic</button>
            <button class="btn small" id="btnRitual">Rituel 10s</button>
          </div>
        </div>
      </div>
    </section>

    <!-- CAPTURE -->
    <section class="card captureView" id="viewCapture" aria-label="Inbox">
      <textarea id="taInbox" placeholder="" aria-label="Saisie Inbox"></textarea>
      <div class="row" style="margin-top:10px;">
        <div class="quiet">Ctrl/⌘ + Enter</div>
        <div class="row" style="gap:8px;">
          <button class="btn small ok" id="btnAdd">Ajouter</button>
          <button class="btn small" id="btnToTriage">Aller au tri</button>
        </div>
      </div>
    </section>

    <!-- TRIAGE -->
    <section class="triageView" id="viewTriage" aria-label="Tri">
      <div class="grid2">
        <section class="card" aria-label="Liste Inbox">
          <div class="row">
            <b style="font-weight:950; letter-spacing:0.08em; text-transform:uppercase; font-size:12px; color:var(--muted);">Inbox</b>
            <span class="dragHint">drag →</span>
          </div>
          <div class="list" id="listInbox" aria-label="Tâches Inbox"></div>
        </section>

        <section class="card" aria-label="Liste Tri">
          <div class="row">
            <b style="font-weight:950; letter-spacing:0.08em; text-transform:uppercase; font-size:12px; color:var(--muted);">Tri</b>
            <span class="dragHint">← drag</span>
          </div>
          <div class="list" id="listTriage" aria-label="Tâches triées"></div>
        </section>
      </div>

      <section class="card" style="margin-top:10px;" aria-label="Terminé">
        <div class="row">
          <b style="font-weight:950; letter-spacing:0.08em; text-transform:uppercase; font-size:12px; color:var(--muted);">Terminé</b>
        </div>
        <div class="list" id="listDone" aria-label="Tâches terminées"></div>
      </section>
    </section>

    <!-- FOCUS -->
    <section class="focusView" id="viewFocus" aria-label="Focus">
      <div class="focusWrap">
        <div class="focusCard">
          <div class="focusTask" id="focusTaskText">Aucune</div>

          <div class="focusStats">
            <div class="stat">
              <span>Restant</span>
              <b id="focusTorions">0</b>
            </div>
            <div class="stat">
              <span>Minuteur</span>
              <b id="focusTimer">—</b>
            </div>
          </div>

          <div class="ring" id="focusRing" style="--p:0deg;">
            <div class="ringCenter">
              <div class="pct" id="focusPct">0%</div>
              <div class="lbl">progression</div>
            </div>
          </div>

          <div class="focusBtns">
            <button class="bigBtn primary" id="btnDego">Dégommer 1 torion</button>
            <button class="bigBtn" id="btnTimer">Démarrer</button>
            <button class="bigBtn" id="btnFinish">Terminer</button>
            <button class="bigBtn" id="btnExitFocus">Sortir</button>
          </div>
        </div>
      </div>
    </section>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

<script>
(() => {
  "use strict";

  const LS_KEY = "eliminator_min_v1";

  const el = (id) => document.getElementById(id);

  const tabCapture = el("tabCapture");
  const tabTriage  = el("tabTriage");
  const tabFocus   = el("tabFocus");

  const viewCapture = el("viewCapture");
  const viewTriage  = el("viewTriage");
  const viewFocus   = el("viewFocus");

  const taInbox = el("taInbox");
  const btnAdd = el("btnAdd");
  const btnToTriage = el("btnToTriage");

  const listInbox = el("listInbox");
  const listTriage = el("listTriage");
  const listDone = el("listDone");

  const btnPanel = el("btnPanel");
  const btnUndo = el("btnUndo");
  const btnRedo = el("btnRedo");

  const selTorionMinutes = el("selTorionMinutes");
  const selEnergyFilter = el("selEnergyFilter");
  const selTunnel = el("selTunnel");

  const btnExport = el("btnExport");
  const btnImport = el("btnImport");
  const btnResetAll = el("btnResetAll");

  const btnPreset = el("btnPreset");
  const btnPresetPrev = el("btnPresetPrev");
  const btnPresetNext = el("btnPresetNext");
  const btnPresetAdd = el("btnPresetAdd");
  const btnPresetEdit = el("btnPresetEdit");
  const btnPresetDel = el("btnPresetDel");

  const btnPanic = el("btnPanic");
  const btnRitual = el("btnRitual");

  // Focus UI
  const focusTaskText = el("focusTaskText");
  const focusTorions = el("focusTorions");
  const focusTimer = el("focusTimer");
  const focusPct = el("focusPct");
  const focusRing = el("focusRing");

  const btnDego = el("btnDego");
  const btnTimer = el("btnTimer");
  const btnFinish = el("btnFinish");
  const btnExitFocus = el("btnExitFocus");

  const toast = el("toast");

  // ---------- State ----------
  let state = load() || makeInitial();

  // History snapshots (light)
  const MAX_HISTORY = 40;

  function makeInitial(){
    return {
      version: 1,
      torionMinutes: 5,
      activePresetId: "p_default",
      presets: [{
        id: "p_default",
        name: "Base",
        defaults: {
          context: "Travail",
          category: "Sans catégorie",
          priority: 2,
          torions: 3,
          energy: "moyen"
        }
      }],
      tasks: [],
      focus: { taskId: null, running: false, endsAt: null, secondsLeft: 0, tunnel: false, ritualDone: false },
      ui: { mode: "triage", panelOpen: true, energyFilter: "tous" },
      history: { undo: [], redo: [] }
    };
  }

  function save(){
    localStorage.setItem(LS_KEY, JSON.stringify(state));
  }

  function load(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return null;
      const obj = JSON.parse(raw);
      if(!obj || !Array.isArray(obj.tasks) || !Array.isArray(obj.presets)) return null;
      return obj;
    }catch{
      return null;
    }
  }

  function pushHistory(){
    // store snapshots without history itself
    const snapshot = structuredClone({
      ...state,
      history: { undo: [], redo: [] }
    });
    state.history.undo.push(snapshot);
    if(state.history.undo.length > MAX_HISTORY) state.history.undo.shift();
    state.history.redo = [];
    save();
    updateUndoRedoBtns();
  }

  function undo(){
    if(!state.history.undo.length) return;
    const prev = state.history.undo.pop();
    const current = structuredClone({ ...state, history: { undo: [], redo: [] }});
    state.history.redo.push(current);
    state = { ...prev, history: state.history };
    save();
    renderAll();
  }

  function redo(){
    if(!state.history.redo.length) return;
    const next = state.history.redo.pop();
    const current = structuredClone({ ...state, history: { undo: [], redo: [] }});
    state.history.undo.push(current);
    state = { ...next, history: state.history };
    save();
    renderAll();
  }

  function updateUndoRedoBtns(){
    btnUndo.disabled = state.history.undo.length === 0;
    btnRedo.disabled = state.history.redo.length === 0;
  }

  // ---------- Helpers ----------
  function uid(){
    return Math.random().toString(36).slice(2,10) + "-" + Date.now().toString(36);
  }
  function now(){ return Date.now(); }
  function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }

  function showToast(msg){
    toast.textContent = msg;
    toast.classList.add("show");
    setTimeout(()=> toast.classList.remove("show"), 1100);
  }

  function activePreset(){
    return state.presets.find(p => p.id === state.activePresetId) || state.presets[0];
  }

  function setMode(mode){
    state.ui.mode = mode;
    save();
    renderMode();
  }

  function renderMode(){
    // tabs
    tabCapture.classList.toggle("active", state.ui.mode === "capture");
    tabTriage.classList.toggle("active",  state.ui.mode === "triage");
    tabFocus.classList.toggle("active",   state.ui.mode === "focus");

    tabCapture.setAttribute("aria-selected", state.ui.mode === "capture" ? "true" : "false");
    tabTriage.setAttribute("aria-selected",  state.ui.mode === "triage" ? "true" : "false");
    tabFocus.setAttribute("aria-selected",   state.ui.mode === "focus" ? "true" : "false");

    // views
    viewCapture.style.display = (state.ui.mode === "capture") ? "block" : "none";
    viewTriage.style.display  = (state.ui.mode === "triage")  ? "block" : "none";
    viewFocus.style.display   = (state.ui.mode === "focus")   ? "block" : "none";

    document.body.classList.toggle("focus", state.ui.mode === "focus");
  }

  function togglePanel(){
    state.ui.panelOpen = !state.ui.panelOpen;
    document.body.classList.toggle("panelOpen", state.ui.panelOpen);
    save();
  }

  function updatePresetLabel(){
    btnPreset.textContent = activePreset().name;
  }

  function computePercent(task){
    if(!task) return 0;
    const total = Math.max(1, task.torionsTotal || 1);
    const rem = clamp(task.torionsRemaining || 0, 0, total);
    return clamp(Math.round((1 - rem/total) * 100), 0, 100);
  }

  function formatTimer(s){
    if(!Number.isFinite(s) || s <= 0) return "—";
    const m = Math.floor(s/60);
    const r = s % 60;
    return `${String(m).padStart(2,"0")}:${String(r).padStart(2,"0")}`;
  }

  // ---------- Tri assisté (heuristiques simples) ----------
  function suggestFields(text){
    const t = (text || "").toLowerCase();

    let category = activePreset().defaults.category;
    let context  = activePreset().defaults.context;
    let torions  = activePreset().defaults.torions;
    let priority = activePreset().defaults.priority;
    let energy   = activePreset().defaults.energy;

    const has = (re) => re.test(t);

    if(has(/\b(appeler|tel|téléphone|contacter)\b/)){
      category = "Appels";
      torions = 1;
      energy = "faible";
    }
    if(has(/\b(encoder|encodage|note)\b/)){
      category = "Encodage";
      torions = Math.max(torions, 3);
      energy = "faible";
    }
    if(has(/\b(rapport|rédaction|lettre|dossier)\b/)){
      category = "Rédaction";
      torions = Math.max(torions, 5);
      energy = "moyen";
    }
    if(has(/\b(urgent|aujourd)\b/)){
      priority = 3;
    }
    if(has(/\b(maison|perso)\b/)){
      context = "Maison";
    }
    if(has(/\b(travail|hopital|hôpital|patient)\b/)){
      context = "Travail";
    }

    // torions explicites: "(3)" ou "3t"
    const m = t.match(/(?:\(|\s)(\d{1,2})\s*(?:t|torion|torions)\b/);
    if(m){
      const v = clamp(parseInt(m[1],10) || torions, 1, 50);
      torions = v;
    }

    return { category, context, torions, priority, energy };
  }

  // ---------- Capture ----------
  function addFromInbox(){
    const raw = taInbox.value || "";
    const lines = raw.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
    if(!lines.length){
      showToast("Vide.");
      return;
    }

    pushHistory();

    const baseOrder = nextOrder("inbox");
    const preset = activePreset();

    lines.forEach((line, idx) => {
      const sug = suggestFields(line);
      state.tasks.push({
        id: uid(),
        text: line,
        list: "inbox",
        order: baseOrder + idx,
        context: sug.context ?? preset.defaults.context,
        category: sug.category ?? preset.defaults.category,
        priority: sug.priority ?? preset.defaults.priority,
        energy: sug.energy ?? preset.defaults.energy,
        torionsTotal: sug.torions ?? preset.defaults.torions,
        torionsRemaining: sug.torions ?? preset.defaults.torions,
        createdAt: now(),
        updatedAt: now(),
        doneAt: null
      });
    });

    taInbox.value = "";
    save();
    renderLists();
    showToast("Ajouté.");
  }

  function nextOrder(listName){
    const items = state.tasks.filter(t => t.list === listName);
    if(!items.length) return 1;
    return Math.max(...items.map(t => t.order || 0)) + 1;
  }

  // ---------- Lists ----------
  function filteredTasks(listName){
    const energyFilter = state.ui.energyFilter || "tous";
    return state.tasks
      .filter(t => t.list === listName)
      .filter(t => {
        if(energyFilter === "tous") return true;
        return (t.energy || "moyen") === energyFilter;
      })
      .sort((a,b) => (a.order||0) - (b.order||0));
  }

  function renderLists(){
    listInbox.innerHTML = "";
    listTriage.innerHTML = "";
    listDone.innerHTML = "";

    filteredTasks("inbox").forEach(t => listInbox.appendChild(renderTask(t)));
    filteredTasks("triage").forEach(t => listTriage.appendChild(renderTask(t)));
    state.tasks
      .filter(t => t.list === "done")
      .sort((a,b)=> (b.doneAt||0) - (a.doneAt||0))
      .slice(0, 50)
      .forEach(t => listDone.appendChild(renderDone(t)));

    updatePresetLabel();
    updateUndoRedoBtns();
  }

  function renderDone(task){
    const wrap = document.createElement("div");
    wrap.className = "task";
    wrap.innerHTML = `
      <div class="taskTop">
        <div class="taskText done">${escapeHtml(task.text)}</div>
        <div class="controls">
          <button class="btn small" data-act="restore">Restaurer</button>
          <button class="btn small danger" data-act="delete">Supprimer</button>
        </div>
      </div>
      <div class="pillRow">
        <span class="pill">${escapeHtml(task.context || "—")}</span>
        <span class="pill">${escapeHtml(task.category || "—")}</span>
      </div>
    `;
    wrap.querySelector('[data-act="restore"]').addEventListener("click", ()=>{
      pushHistory();
      task.list = "triage";
      task.doneAt = null;
      task.torionsRemaining = Math.max(1, task.torionsRemaining || task.torionsTotal || 1);
      task.updatedAt = now();
      task.order = nextOrder("triage");
      save();
      renderLists();
    });

    wrap.querySelector('[data-act="delete"]').addEventListener("click", ()=>{
      if(!confirm("Supprimer ?")) return;
      pushHistory();
      state.tasks = state.tasks.filter(x => x.id !== task.id);
      save();
      renderLists();
    });

    return wrap;
  }

  function renderTask(task){
    const wrap = document.createElement("div");
    wrap.className = "task";
    wrap.draggable = true;
    wrap.dataset.id = task.id;

    const p = computePercent(task);

    wrap.innerHTML = `
      <div class="taskTop">
        <div>
          <div class="taskText">${escapeHtml(task.text)}</div>
          <div class="pillRow" style="margin-top:8px;">
            <span class="pill">${escapeHtml(task.context || "—")}</span>
            <span class="pill">${escapeHtml(task.category || "—")}</span>
            <span class="pill">P${escapeHtml(String(task.priority || 2))}</span>
            <span class="pill">${escapeHtml(String(task.torionsRemaining || 0))}/${escapeHtml(String(task.torionsTotal || 0))} torions</span>
            <span class="pill">${p}%</span>
          </div>
        </div>

        <div class="controls">
          <button class="btn small ok" data-act="focus">Focus</button>
          <button class="btn small" data-act="done">Terminer</button>
          <button class="btn small danger" data-act="delete">Supprimer</button>
        </div>
      </div>

      <div class="editRow" aria-label="Édition">
        <select data-field="context" aria-label="Contexte">
          ${optionHtml(task.context, ["Travail","Maison","Dehors","Autre"])}
        </select>

        <input type="text" data-field="category" aria-label="Catégorie" value="${escapeAttr(task.category || "")}" />

        <select data-field="priority" aria-label="Priorité">
          ${optionHtml(String(task.priority||2), ["1","2","3"])}
        </select>

        <select data-field="energy" aria-label="Énergie">
          ${optionHtml(task.energy || "moyen", ["faible","moyen","haut"])}
        </select>
      </div>

      <div class="editRow" style="grid-template-columns: 1fr 1fr;" aria-label="Estimation">
        <input type="number" min="1" max="50" step="1" data-field="torionsTotal" aria-label="Torions (total)" value="${escapeAttr(String(task.torionsTotal||1))}" />
        <button class="btn small" data-act="move">${task.list === "inbox" ? "→ Tri" : "← Inbox"}</button>
      </div>
    `;

    // Actions
    wrap.querySelector('[data-act="focus"]').addEventListener("click", ()=> startFocus(task.id));
    wrap.querySelector('[data-act="done"]').addEventListener("click", ()=> markDone(task.id));
    wrap.querySelector('[data-act="delete"]').addEventListener("click", ()=> deleteTask(task.id));
    wrap.querySelector('[data-act="move"]').addEventListener("click", ()=> toggleList(task.id));

    // Edits
    wrap.querySelectorAll("[data-field]").forEach(inp => {
      inp.addEventListener("change", ()=> {
        pushHistory();
        const field = inp.dataset.field;
        if(field === "torionsTotal"){
          const v = clamp(parseInt(inp.value,10) || 1, 1, 50);
          task.torionsTotal = v;
          task.torionsRemaining = clamp(task.torionsRemaining ?? v, 0, v);
        }else if(field === "priority"){
          task.priority = clamp(parseInt(inp.value,10) || 2, 1, 3);
        }else if(field === "energy"){
          task.energy = inp.value;
        }else if(field === "context"){
          task.context = inp.value;
        }else if(field === "category"){
          task.category = (inp.value || "").trim() || "Sans catégorie";
        }
        task.updatedAt = now();
        save();
        renderLists();
      });
    });

    // Drag
    wrap.addEventListener("dragstart", (e)=>{
      wrap.classList.add("dragging");
      e.dataTransfer.setData("text/plain", task.id);
      e.dataTransfer.effectAllowed = "move";
    });
    wrap.addEventListener("dragend", ()=>{
      wrap.classList.remove("dragging");
      listInbox.classList.remove("dropZone");
      listTriage.classList.remove("dropZone");
    });

    return wrap;
  }

  function toggleList(taskId){
    const task = state.tasks.find(t => t.id === taskId);
    if(!task) return;
    pushHistory();
    task.list = task.list === "inbox" ? "triage" : "inbox";
    task.order = nextOrder(task.list);
    task.updatedAt = now();
    save();
    renderLists();
  }

  function deleteTask(taskId){
    const task = state.tasks.find(t => t.id === taskId);
    if(!task) return;
    if(!confirm("Supprimer ?")) return;
    pushHistory();
    state.tasks = state.tasks.filter(t => t.id !== taskId);
    save();
    renderLists();
  }

  function markDone(taskId){
    const task = state.tasks.find(t => t.id === taskId);
    if(!task) return;
    pushHistory();
    task.list = "done";
    task.doneAt = now();
    task.torionsRemaining = 0;
    task.updatedAt = now();
    if(state.focus.taskId === taskId){
      stopTimer();
      state.focus.taskId = null;
      state.focus.running = false;
      state.focus.ritualDone = false;
    }
    save();
    renderLists();
    if(state.ui.mode === "focus") renderFocus();
  }

  // Drop zones
  function setupDropZones(){
    [listInbox, listTriage].forEach(zone => {
      zone.addEventListener("dragover", (e)=>{
        e.preventDefault();
        zone.classList.add("dropZone");
        e.dataTransfer.dropEffect = "move";
      });
      zone.addEventListener("dragleave", ()=>{
        zone.classList.remove("dropZone");
      });
      zone.addEventListener("drop", (e)=>{
        e.preventDefault();
        zone.classList.remove("dropZone");
        const id = e.dataTransfer.getData("text/plain");
        const task = state.tasks.find(t => t.id === id);
        if(!task) return;

        pushHistory();
        const targetList = (zone === listInbox) ? "inbox" : "triage";
        task.list = targetList;
        task.order = nextOrder(targetList);
        task.updatedAt = now();
        save();
        renderLists();
      });
    });
  }

  // ---------- Focus ----------
  function startFocus(taskId){
    const task = state.tasks.find(t => t.id === taskId);
    if(!task) return;
    pushHistory();
    state.focus.taskId = taskId;
    state.ui.mode = "focus";
    state.focus.running = false;
    state.focus.endsAt = null;
    state.focus.secondsLeft = 0;
    state.focus.ritualDone = false;
    save();
    renderMode();
    renderFocus();
  }

  function currentTask(){
    return state.tasks.find(t => t.id === state.focus.taskId) || null;
  }

  let tickHandle = null;

  function startTimer(){
    const task = currentTask();
    if(!task) return;
    if(state.focus.tunnel && !state.focus.ritualDone){
      showToast("Rituel.");
      return;
    }
    const seconds = state.torionMinutes * 60;
    state.focus.running = true;
    state.focus.secondsLeft = seconds;
    state.focus.endsAt = now() + seconds*1000;
    save();
    renderFocus();
    scheduleTick();
  }

  function pauseTimer(){
    state.focus.running = false;
    state.focus.endsAt = null;
    save();
    renderFocus();
    if(tickHandle){ clearInterval(tickHandle); tickHandle = null; }
  }

  function stopTimer(){
    state.focus.running = false;
    state.focus.endsAt = null;
    state.focus.secondsLeft = 0;
    if(tickHandle){ clearInterval(tickHandle); tickHandle = null; }
    save();
  }

  function scheduleTick(){
    if(tickHandle) clearInterval(tickHandle);
    tickHandle = setInterval(()=>{
      if(!state.focus.running || !state.focus.endsAt) return;
      const leftMs = state.focus.endsAt - now();
      const left = Math.max(0, Math.ceil(leftMs / 1000));
      state.focus.secondsLeft = left;

      if(left <= 0){
        // torion finished
        pushHistory();
        degoOneTorion();
        stopTimer();
        // auto-restart in tunnel? no, keep explicit
        renderFocus();
        renderLists();
        showToast("Torion.");
        return;
      }
      save();
      renderFocus();
    }, 250);
  }

  function degoOneTorion(){
    const task = currentTask();
    if(!task) return;

    if(state.focus.tunnel && !state.focus.ritualDone){
      showToast("Rituel.");
      return;
    }

    if(task.torionsRemaining <= 0){
      return;
    }
    pushHistory();
    task.torionsRemaining = Math.max(0, (task.torionsRemaining || 0) - 1);
    task.updatedAt = now();

    if(task.torionsRemaining <= 0){
      markDone(task.id);
      return;
    }

    save();
    renderFocus();
    renderLists();
  }

  function renderFocus(){
    const task = currentTask();

    if(!task){
      focusTaskText.textContent = "Aucune";
      focusTorions.textContent = "0";
      focusTimer.textContent = "—";
      focusPct.textContent = "0%";
      focusRing.style.setProperty("--p","0deg");
      btnDego.disabled = true;
      btnTimer.disabled = true;
      btnFinish.disabled = true;
      return;
    }

    focusTaskText.textContent = task.text;
    focusTorions.textContent = String(task.torionsRemaining || 0);

    const pct = computePercent(task);
    focusPct.textContent = `${pct}%`;
    focusRing.style.setProperty("--p", `${pct*3.6}deg`);

    focusTimer.textContent = formatTimer(state.focus.secondsLeft);

    btnDego.disabled = false;
    btnFinish.disabled = false;

    btnTimer.textContent = state.focus.running ? "Pause" : "Démarrer";
  }

  function exitFocus(){
    stopTimer();
    state.ui.mode = "triage";
    save();
    renderMode();
  }

  // ---------- Panic & Ritual ----------
  function ritual10s(){
    // “simulable”: simple countdown 10s, pas d’animation inutile
    state.focus.ritualDone = false;
    save();

    let left = 10;
    showToast("10s");
    const h = setInterval(()=>{
      left--;
      if(left <= 0){
        clearInterval(h);
        state.focus.ritualDone = true;
        save();
        showToast("OK");
        return;
      }
    }, 1000);
  }

  function pickWeightedTask(){
    // pondéré par torions restants, uniquement triage+inbox (pas done)
    const candidates = state.tasks
      .filter(t => t.list !== "done")
      .filter(t => (t.torionsRemaining || 0) > 0);

    if(!candidates.length) return null;

    const weights = candidates.map(t => Math.max(1, Math.ceil(t.torionsRemaining)));
    const total = weights.reduce((a,b)=>a+b,0);
    let r = Math.random()*total;
    for(let i=0;i<candidates.length;i++){
      r -= weights[i];
      if(r <= 0) return candidates[i];
    }
    return candidates[candidates.length-1];
  }

  function panic(){
    const t = pickWeightedTask();
    if(!t){
      showToast("Vide.");
      return;
    }
    startFocus(t.id);
    // démarre 1 torion direct, si pas de tunnel ou ritual done
    if(state.focus.tunnel){
      showToast("Rituel.");
    }else{
      startTimer();
    }
  }

  // ---------- Presets ----------
  function presetPrev(){
    const idx = state.presets.findIndex(p => p.id === state.activePresetId);
    const next = (idx <= 0) ? state.presets.length - 1 : idx - 1;
    state.activePresetId = state.presets[next].id;
    save();
    updatePresetLabel();
    showToast(state.presets[next].name);
  }

  function presetNext(){
    const idx = state.presets.findIndex(p => p.id === state.activePresetId);
    const next = (idx >= state.presets.length - 1) ? 0 : idx + 1;
    state.activePresetId = state.presets[next].id;
    save();
    updatePresetLabel();
    showToast(state.presets[next].name);
  }

  function presetAdd(){
    const name = prompt("Nom", "Nouveau");
    if(!name) return;
    pushHistory();
    const id = "p_" + uid();
    const base = activePreset().defaults;
    state.presets.push({
      id,
      name: name.trim().slice(0,24),
      defaults: { ...base }
    });
    state.activePresetId = id;
    save();
    updatePresetLabel();
    showToast("OK");
  }

  function presetEdit(){
    const p = activePreset();
    const name = prompt("Nom", p.name);
    if(name === null) return;

    const context = prompt("Contexte", p.defaults.context);
    if(context === null) return;

    const category = prompt("Catégorie", p.defaults.category);
    if(category === null) return;

    const tor = prompt("Torions", String(p.defaults.torions));
    if(tor === null) return;

    const pr = prompt("Priorité (1-3)", String(p.defaults.priority));
    if(pr === null) return;

    const en = prompt("Énergie (faible/moyen/haut)", p.defaults.energy);
    if(en === null) return;

    pushHistory();
    p.name = name.trim().slice(0,24) || p.name;
    p.defaults.context = (context.trim() || p.defaults.context);
    p.defaults.category = (category.trim() || p.defaults.category);
    p.defaults.torions = clamp(parseInt(tor,10) || p.defaults.torions, 1, 50);
    p.defaults.priority = clamp(parseInt(pr,10) || p.defaults.priority, 1, 3);
    p.defaults.energy = (["faible","moyen","haut"].includes((en||"").trim()) ? en.trim() : p.defaults.energy);
    save();
    updatePresetLabel();
    showToast("OK");
  }

  function presetDel(){
    if(state.presets.length <= 1){
      showToast("Non.");
      return;
    }
    if(!confirm("Supprimer preset ?")) return;
    pushHistory();
    const id = state.activePresetId;
    state.presets = state.presets.filter(p => p.id !== id);
    state.activePresetId = state.presets[0].id;
    save();
    updatePresetLabel();
    showToast("OK");
  }

  // ---------- Export/Import ----------
  function exportJson(){
    const payload = structuredClone(state);
    // ne pas exporter l’historique (optionnel)
    payload.history = { undo: [], redo: [] };

    const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "eliminator.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    showToast("Export.");
  }

  function importJson(){
    const input = document.createElement("input");
    input.type = "file";
    input.accept = "application/json";
    input.onchange = async () => {
      const file = input.files && input.files[0];
      if(!file) return;
      try{
        const txt = await file.text();
        const obj = JSON.parse(txt);
        if(!obj || !Array.isArray(obj.tasks) || !Array.isArray(obj.presets)){
          showToast("JSON?");
          return;
        }
        pushHistory();
        state = { ...obj, history: state.history };
        save();
        renderAll();
        showToast("Import.");
      }catch{
        showToast("JSON?");
      }
    };
    input.click();
  }

  function resetAll(){
    if(!confirm("Reset ?")) return;
    state = makeInitial();
    save();
    renderAll();
    showToast("OK");
  }

  // ---------- UI wiring ----------
  function renderAll(){
    // panel
    document.body.classList.toggle("panelOpen", !!state.ui.panelOpen);
    selTorionMinutes.value = String(state.torionMinutes || 5);
    selEnergyFilter.value = state.ui.energyFilter || "tous";
    selTunnel.value = state.focus.tunnel ? "on" : "off";
    updatePresetLabel();
    renderMode();
    renderLists();
    renderFocus();
    updateUndoRedoBtns();
  }

  // Tabs
  tabCapture.addEventListener("click", ()=> setMode("capture"));
  tabTriage.addEventListener("click", ()=> setMode("triage"));
  tabFocus.addEventListener("click", ()=>{
    if(!state.focus.taskId){
      // si aucun focus, on choisit la première tâche triée, sinon la première inbox
      const cand = filteredTasks("triage")[0] || filteredTasks("inbox")[0];
      if(cand) startFocus(cand.id);
      else { showToast("Vide."); return; }
    }else{
      state.ui.mode = "focus";
      save();
      renderMode();
      renderFocus();
    }
  });

  // Panel toggle
  btnPanel.addEventListener("click", togglePanel);

  // Inbox add
  btnAdd.addEventListener("click", addFromInbox);
  btnToTriage.addEventListener("click", ()=> setMode("triage"));

  // Panel controls
  selTorionMinutes.addEventListener("change", ()=>{
    pushHistory();
    state.torionMinutes = (Number(selTorionMinutes.value) === 10) ? 10 : 5;
    save();
    showToast("OK");
  });
  selEnergyFilter.addEventListener("change", ()=>{
    state.ui.energyFilter = selEnergyFilter.value;
    save();
    renderLists();
  });
  selTunnel.addEventListener("change", ()=>{
    state.focus.tunnel = (selTunnel.value === "on");
    save();
    showToast("OK");
  });

  btnUndo.addEventListener("click", undo);
  btnRedo.addEventListener("click", redo);

  btnExport.addEventListener("click", exportJson);
  btnImport.addEventListener("click", importJson);
  btnResetAll.addEventListener("click", resetAll);

  btnPresetPrev.addEventListener("click", presetPrev);
  btnPresetNext.addEventListener("click", presetNext);
  btnPresetAdd.addEventListener("click", presetAdd);
  btnPresetEdit.addEventListener("click", presetEdit);
  btnPresetDel.addEventListener("click", presetDel);

  btnPanic.addEventListener("click", panic);
  btnRitual.addEventListener("click", ritual10s);

  // Focus buttons
  btnDego.addEventListener("click", ()=>{
    degoOneTorion();
    renderFocus();
  });

  btnTimer.addEventListener("click", ()=>{
    if(!currentTask()) return;
    if(state.focus.running) pauseTimer();
    else startTimer();
  });

  btnFinish.addEventListener("click", ()=>{
    const t = currentTask();
    if(!t) return;
    markDone(t.id);
    renderFocus();
    showToast("OK");
  });

  btnExitFocus.addEventListener("click", exitFocus);

  // Keyboard shortcuts
  window.addEventListener("keydown", (e)=>{
    const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : "";
    const inField = (tag === "textarea" || tag === "input" || tag === "select");

    // Ctrl/⌘+Enter => add inbox
    if(inField && tag === "textarea" && (e.ctrlKey || e.metaKey) && e.key === "Enter"){
      e.preventDefault();
      addFromInbox();
      return;
    }

    // Undo/Redo
    if((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "z" && !e.shiftKey){
      e.preventDefault(); undo(); return;
    }
    if((e.ctrlKey || e.metaKey) && (e.key.toLowerCase() === "z") && e.shiftKey){
      e.preventDefault(); redo(); return;
    }

    // Presets
    if(e.altKey && e.key === "ArrowLeft"){ e.preventDefault(); presetPrev(); return; }
    if(e.altKey && e.key === "ArrowRight"){ e.preventDefault(); presetNext(); return; }

    if(inField) return;

    // Focus
    if(e.key.toLowerCase() === "f"){
      e.preventDefault();
      tabFocus.click();
      return;
    }
    if(e.key === "Escape" && state.ui.mode === "focus"){
      e.preventDefault();
      exitFocus();
      return;
    }
  });

  // Swipe to switch presets (simple, sur header)
  let sx = null;
  let st = null;
  const headerEl = document.querySelector("header");
  headerEl.addEventListener("pointerdown", (e)=>{
    sx = e.clientX;
    st = Date.now();
  });
  headerEl.addEventListener("pointerup", (e)=>{
    if(sx === null) return;
    const dx = e.clientX - sx;
    const dt = Date.now() - st;
    sx = null; st = null;
    if(dt > 500) return;
    if(Math.abs(dx) < 60) return;
    if(dx < 0) presetNext();
    else presetPrev();
  });

  // Drag & drop zones
  setupDropZones();

  // ---------- Focus initial ----------
  function stopIfNoTask(){
    if(state.ui.mode === "focus" && !currentTask()){
      exitFocus();
    }
  }

  // ---------- Utils ----------
  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[c]));
  }
  function escapeAttr(s){
    return escapeHtml(s).replace(/"/g, "&quot;");
  }
  function optionHtml(current, options){
    return options.map(v => {
      const sel = String(v) === String(current) ? "selected" : "";
      return `<option value="${escapeAttr(v)}" ${sel}>${escapeHtml(v)}</option>`;
    }).join("");
  }

  // ---------- Start ----------
  // sanity defaults
  state.torionMinutes = (state.torionMinutes === 10) ? 10 : 5;
  document.body.classList.toggle("panelOpen", !!state.ui.panelOpen);
  renderAll();
  stopIfNoTask();
})();
</script>
</body>
</html>
